import { Database } from './database';

export class SlugService {
  // Generate a URL-friendly slug from a title
  static generateSlug(title: string): string {
    return title
      .toLowerCase()
      .normalize('NFD') // Decompose accented characters
      .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
      .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
      .replace(/\s+/g, '-') // Replace spaces with hyphens
      .replace(/-+/g, '-') // Replace multiple hyphens with single
      .replace(/^-|-$/g, '') // Remove leading/trailing hyphens
      .substring(0, 50); // Limit length
  }

  // Generate a unique slug by checking database and adding suffix if needed
  static async generateUniqueSlug(title: string, excludeId?: string): Promise<string> {
    let baseSlug = this.generateSlug(title);
    let slug = baseSlug;
    let counter = 1;

    // If base slug is empty, use a default
    if (!slug) {
      slug = 'quiz';
      baseSlug = 'quiz';
    }

    // Check if slug is available
    while (!(await Database.isSlugAvailable(slug, excludeId))) {
      slug = `${baseSlug}-${counter}`;
      counter++;
    }

    return slug;
  }

  // Validate slug format
  static isValidSlug(slug: string): boolean {
    const slugRegex = /^[a-z0-9]+(?:-[a-z0-9]+)*$/;
    return slugRegex.test(slug) && slug.length >= 3 && slug.length <= 50;
  }

  // Check if a custom slug is available
  static async isSlugAvailable(slug: string, excludeId?: string): Promise<boolean> {
    if (!this.isValidSlug(slug)) {
      return false;
    }
    return Database.isSlugAvailable(slug, excludeId);
  }

  // Reserved slugs that cannot be used
  static readonly RESERVED_SLUGS = [
    'admin',
    'api',
    'app',
    'www',
    'mail',
    'ftp',
    'blog',
    'shop',
    'store',
    'help',
    'support',
    'about',
    'contact',
    'terms',
    'privacy',
    'login',
    'register',
    'signup',
    'signin',
    'logout',
    'dashboard',
    'profile',
    'settings',
    'account',
    'billing',
    'upgrade',
    'premium',
    'pro',
    'enterprise',
    'business',
    'pricing',
    'features',
    'docs',
    'documentation',
    'guide',
    'tutorial',
    'examples',
    'demo',
    'test',
    'staging',
    'dev',
    'development',
    'production',
    'prod',
    'beta',
    'alpha',
    'preview',
    'cdn',
    'assets',
    'static',
    'public',
    'private',
    'secure',
    'ssl',
    'tls',
    'https',
    'http',
    'ftp',
    'sftp',
    'ssh',
    'vpn',
    'dns',
    'mx',
    'ns',
    'cname',
    'txt',
    'a',
    'aaaa',
    'srv',
    'ptr',
    'soa',
    'root',
    'administrator',
    'moderator',
    'user',
    'guest',
    'anonymous',
    'public',
    'private',
    'system',
    'config',
    'configuration',
    'setup',
    'install',
    'installation',
    'update',
    'upgrade',
    'download',
    'upload',
    'file',
    'files',
    'image',
    'images',
    'video',
    'videos',
    'audio',
    'music',
    'media',
    'content',
    'data',
    'database',
    'db',
    'sql',
    'mysql',
    'postgres',
    'mongodb',
    'redis',
    'cache',
    'session',
    'cookie',
    'auth',
    'oauth',
    'jwt',
    'token',
    'key',
    'secret',
    'password',
    'hash',
    'encrypt',
    'decrypt',
    'security',
    'firewall',
    'proxy',
    'load-balancer',
    'server',
    'client',
    'service',
    'microservice',
    'webhook',
    'callback',
    'redirect',
    'forward',
    'rewrite',
    'route',
    'router',
    'controller',
    'model',
    'view',
    'template',
    'component',
    'module',
    'plugin',
    'extension',
    'addon',
    'widget',
    'script',
    'style',
    'css',
    'js',
    'javascript',
    'html',
    'xml',
    'json',
    'yaml',
    'yml',
    'toml',
    'ini',
    'env',
    'log',
    'logs',
    'error',
    'errors',
    'exception',
    'debug',
    'trace',
    'monitor',
    'health',
    'status',
    'ping',
    'pong',
    'echo',
    'hello',
    'world',
    'index',
    'home',
    'main',
    'default',
    'null',
    'undefined',
    'void',
    'empty',
    'blank',
    'none',
    'nil',
    'false',
    'true',
    'yes',
    'no',
    'on',
    'off',
    'enable',
    'disable',
    'active',
    'inactive',
    'online',
    'offline',
    'live',
    'dead',
    'new',
    'old',
    'create',
    'read',
    'update',
    'delete',
    'edit',
    'remove',
    'add',
    'insert',
    'select',
    'search',
    'find',
    'filter',
    'sort',
    'order',
    'group',
    'join',
    'union',
    'intersect',
    'except',
    'distinct',
    'unique',
    'duplicate',
    'copy',
    'clone',
    'backup',
    'restore',
    'import',
    'export',
    'sync',
    'async',
    'queue',
    'job',
    'task',
    'worker',
    'process',
    'thread',
    'lock',
    'unlock',
    'wait',
    'notify',
    'signal',
    'event',
    'trigger',
    'action',
    'function',
    'method',
    'class',
    'object',
    'instance',
    'property',
    'attribute',
    'field',
    'column',
    'row',
    'table',
    'schema',
    'migration',
    'seed',
    'factory',
    'fixture',
    'mock',
    'stub',
    'spy',
    'test',
    'spec',
    'unit',
    'integration',
    'e2e',
    'acceptance',
    'performance',
    'load',
    'stress',
    'benchmark',
    'profile',
    'optimize',
    'compress',
    'minify',
    'bundle',
    'build',
    'compile',
    'transpile',
    'lint',
    'format',
    'validate',
    'verify',
    'check',
    'audit',
    'scan',
    'analyze',
    'report',
    'metric',
    'analytics',
    'tracking',
    'pixel',
    'tag',
    'gtm',
    'ga',
    'facebook',
    'google',
    'twitter',
    'linkedin',
    'instagram',
    'youtube',
    'tiktok',
    'snapchat',
    'pinterest',
    'reddit',
    'discord',
    'slack',
    'teams',
    'zoom',
    'meet',
    'calendar',
    'schedule',
    'appointment',
    'booking',
    'reservation',
    'order',
    'cart',
    'checkout',
    'payment',
    'billing',
    'invoice',
    'receipt',
    'refund',
    'subscription',
    'plan',
    'tier',
    'package',
    'bundle',
    'deal',
    'offer',
    'discount',
    'coupon',
    'promo',
    'campaign',
    'marketing',
    'advertising',
    'ad',
    'banner',
    'popup',
    'modal',
    'dialog',
    'alert',
    'notification',
    'message',
    'email',
    'sms',
    'push',
    'newsletter',
    'feed',
    'rss',
    'atom',
    'sitemap',
    'robots',
    'humans',
    'manifest',
    'favicon',
    'icon',
    'logo',
    'brand',
    'theme',
    'skin',
    'layout',
    'design',
    'ui',
    'ux',
    'frontend',
    'backend',
    'fullstack',
    'devops',
    'sysadmin',
    'dba',
    'qa',
    'qc',
    'pm',
    'po',
    'ba',
    'sa',
    'architect',
    'engineer',
    'developer',
    'programmer',
    'coder',
    'hacker',
    'ninja',
    'guru',
    'expert',
    'master',
    'senior',
    'junior',
    'intern',
    'trainee',
    'student',
    'teacher',
    'mentor',
    'coach',
    'consultant',
    'freelancer',
    'contractor',
    'employee',
    'staff',
    'team',
    'group',
    'organization',
    'company',
    'corporation',
    'business',
    'enterprise',
    'startup',
    'agency',
    'studio',
    'lab',
    'workshop',
    'conference',
    'meetup',
    'event',
    'webinar',
    'course',
    'training',
    'certification',
    'exam',
    'quiz',
    'survey',
    'poll',
    'vote',
    'feedback',
    'review',
    'rating',
    'comment',
    'reply',
    'share',
    'like',
    'follow',
    'subscribe',
    'unsubscribe',
    'join',
    'leave',
    'invite',
    'accept',
    'decline',
    'approve',
    'reject',
    'ban',
    'unban',
    'block',
    'unblock',
    'mute',
    'unmute',
    'hide',
    'show',
    'publish',
    'unpublish',
    'draft',
    'preview',
    'schedule',
    'archive',
    'trash',
    'restore',
    'permanent',
    'temporary',
    'public',
    'private',
    'protected',
    'secure',
    'open',
    'closed',
    'locked',
    'unlocked',
    'free',
    'paid',
    'premium',
    'basic',
    'standard',
    'advanced',
    'professional',
    'enterprise',
    'unlimited',
    'limited',
    'trial',
    'demo',
    'sample',
    'example',
    'template',
    'boilerplate',
    'starter',
    'seed',
    'skeleton',
    'framework',
    'library',
    'package',
    'dependency',
    'requirement',
    'specification',
    'standard',
    'protocol',
    'format',
    'encoding',
    'charset',
    'locale',
    'language',
    'translation',
    'localization',
    'internationalization',
    'timezone',
    'date',
    'time',
    'datetime',
    'timestamp',
    'duration',
    'interval',
    'period',
    'range',
    'limit',
    'offset',
    'page',
    'size',
    'count',
    'total',
    'sum',
    'average',
    'mean',
    'median',
    'mode',
    'min',
    'max',
    'first',
    'last',
    'next',
    'previous',
    'current',
    'latest',
    'oldest',
    'newest',
    'recent',
    'popular',
    'trending',
    'featured',
    'recommended',
    'related',
    'similar',
    'random',
    'shuffle',
    'sort',
    'filter',
    'search',
    'query',
    'result',
    'match',
    'hit',
    'miss',
    'found',
    'notfound',
    'exists',
    'missing',
    'available',
    'unavailable',
    'online',
    'offline',
    'connected',
    'disconnected',
    'synced',
    'unsynced',
    'updated',
    'outdated',
    'fresh',
    'stale',
    'cached',
    'uncached',
    'compressed',
    'uncompressed',
    'encrypted',
    'decrypted',
    'signed',
    'unsigned',
    'verified',
    'unverified',
    'authenticated',
    'unauthenticated',
    'authorized',
    'unauthorized',
    'allowed',
    'denied',
    'granted',
    'revoked',
    'enabled',
    'disabled',
    'active',
    'inactive',
    'visible',
    'hidden',
    'shown',
    'collapsed',
    'expanded',
    'opened',
    'closed',
    'started',
    'stopped',
    'paused',
    'resumed',
    'completed',
    'failed',
    'success',
    'error',
    'warning',
    'info',
    'debug',
    'trace',
    'fatal',
    'critical',
    'high',
    'medium',
    'low',
    'urgent',
    'normal',
    'minor',
    'major',
    'patch',
    'hotfix',
    'bugfix',
    'feature',
    'enhancement',
    'improvement',
    'optimization',
    'refactor',
    'cleanup',
    'maintenance',
    'support',
    'help',
    'faq',
    'question',
    'answer',
    'solution',
    'problem',
    'issue',
    'bug',
    'defect',
    'vulnerability',
    'security',
    'privacy',
    'policy',
    'terms',
    'conditions',
    'agreement',
    'contract',
    'license',
    'copyright',
    'trademark',
    'patent',
    'intellectual',
    'property',
    'legal',
    'compliance',
    'gdpr',
    'ccpa',
    'hipaa',
    'sox',
    'pci',
    'iso',
    'soc',
    'audit',
    'certification',
    'accreditation',
    'standard',
    'guideline',
    'best',
    'practice',
    'recommendation',
    'tip',
    'trick',
    'hack',
    'workaround',
    'solution',
    'fix',
    'patch',
    'update',
    'upgrade',
    'migration',
    'transition',
    'change',
    'modification',
    'adjustment',
    'tweak',
    'tune',
    'configure',
    'setup',
    'install',
    'deploy',
    'release',
    'launch',
    'go-live',
    'production',
    'staging',
    'development',
    'testing',
    'qa',
    'uat',
    'acceptance',
    'integration',
    'unit',
    'smoke',
    'regression',
    'performance',
    'load',
    'stress',
    'volume',
    'spike',
    'endurance',
    'scalability',
    'reliability',
    'availability',
    'durability',
    'consistency',
    'integrity',
    'accuracy',
    'precision',
    'quality',
    'excellence',
    'perfection',
    'flawless',
    'seamless',
    'smooth',
    'efficient',
    'effective',
    'productive',
    'profitable',
    'valuable',
    'useful',
    'helpful',
    'beneficial',
    'advantageous',
    'positive',
    'negative',
    'neutral',
    'balanced',
    'fair',
    'equal',
    'diverse',
    'inclusive',
    'accessible',
    'usable',
    'friendly',
    'intuitive',
    'simple',
    'complex',
    'advanced',
    'basic',
    'elementary',
    'fundamental',
    'essential',
    'critical',
    'important',
    'significant',
    'relevant',
    'applicable',
    'suitable',
    'appropriate',
    'correct',
    'right',
    'wrong',
    'incorrect',
    'invalid',
    'valid',
    'legal',
    'illegal',
    'legitimate',
    'authorized',
    'official',
    'unofficial',
    'formal',
    'informal',
    'professional',
    'personal',
    'individual',
    'collective',
    'shared',
    'common',
    'unique',
    'special',
    'custom',
    'standard',
    'default',
    'original',
    'copy',
    'duplicate',
    'replica',
    'clone',
    'backup',
    'archive',
    'history',
    'legacy',
    'deprecated',
    'obsolete',
    'outdated',
    'modern',
    'contemporary',
    'current',
    'latest',
    'newest',
    'recent',
    'old',
    'ancient',
    'vintage',
    'classic',
    'traditional',
    'conventional',
    'innovative',
    'creative',
    'original',
    'revolutionary',
    'groundbreaking',
    'cutting-edge',
    'state-of-the-art',
    'next-generation',
    'future',
    'futuristic',
    'tomorrow',
    'today',
    'yesterday',
    'now',
    'then',
    'when',
    'where',
    'what',
    'who',
    'why',
    'how',
    'which',
    'whose',
    'whom',
    'this',
    'that',
    'these',
    'those',
    'here',
    'there',
    'everywhere',
    'anywhere',
    'somewhere',
    'nowhere',
    'always',
    'never',
    'sometimes',
    'often',
    'rarely',
    'seldom',
    'frequently',
    'occasionally',
    'usually',
    'normally',
    'typically',
    'generally',
    'specifically',
    'particularly',
    'especially',
    'mainly',
    'mostly',
    'primarily',
    'secondarily',
    'additionally',
    'furthermore',
    'moreover',
    'however',
    'nevertheless',
    'nonetheless',
    'otherwise',
    'therefore',
    'thus',
    'hence',
    'consequently',
    'accordingly',
    'subsequently',
    'previously',
    'formerly',
    'originally',
    'initially',
    'finally',
    'ultimately',
    'eventually',
    'immediately',
    'instantly',
    'quickly',
    'rapidly',
    'fast',
    'slow',
    'slowly',
    'gradually',
    'suddenly',
    'abruptly',
    'smoothly',
    'roughly',
    'gently',
    'carefully',
    'cautiously',
    'safely',
    'securely',
    'privately',
    'publicly',
    'openly',
    'secretly',
    'quietly',
    'loudly',
    'clearly',
    'obviously',
    'apparently',
    'evidently',
    'certainly',
    'definitely',
    'absolutely',
    'completely',
    'totally',
    'entirely',
    'fully',
    'partially',
    'partly',
    'somewhat',
    'slightly',
    'barely',
    'hardly',
    'scarcely',
    'almost',
    'nearly',
    'approximately',
    'roughly',
    'exactly',
    'precisely',
    'accurately',
    'correctly',
    'properly',
    'appropriately',
    'suitably',
    'adequately',
    'sufficiently',
    'insufficiently',
    'inadequately',
    'improperly',
    'incorrectly',
    'inaccurately',
    'imprecisely',
    'roughly',
    'approximately',
    'about',
    'around',
    'over',
    'under',
    'above',
    'below',
    'between',
    'among',
    'within',
    'without',
    'inside',
    'outside',
    'before',
    'after',
    'during',
    'while',
    'until',
    'since',
    'from',
    'to',
    'into',
    'onto',
    'upon',
    'across',
    'through',
    'throughout',
    'around',
    'beyond',
    'behind',
    'beside',
    'besides',
    'except',
    'excluding',
    'including',
    'regarding',
    'concerning',
    'about',
    'against',
    'towards',
    'toward',
    'despite',
    'although',
    'though',
    'unless',
    'whether',
    'either',
    'neither',
    'both',
    'all',
    'some',
    'any',
    'many',
    'few',
    'several',
    'various',
    'different',
    'same',
    'similar',
    'identical',
    'equal',
    'equivalent',
    'comparable',
    'relative',
    'absolute',
    'positive',
    'negative',
    'zero',
    'one',
    'two',
    'three',
    'four',
    'five',
    'six',
    'seven',
    'eight',
    'nine',
    'ten',
    'hundred',
    'thousand',
    'million',
    'billion',
    'trillion',
    'infinite',
    'unlimited',
    'limited',
    'finite',
    'endless',
    'boundless',
    'countless',
    'numerous',
    'multiple',
    'single',
    'double',
    'triple',
    'quadruple',
    'quintuple',
    'first',
    'second',
    'third',
    'fourth',
    'fifth',
    'sixth',
    'seventh',
    'eighth',
    'ninth',
    'tenth',
    'last',
    'final',
    'ultimate',
    'primary',
    'secondary',
    'tertiary',
    'main',
    'sub',
    'super',
    'ultra',
    'mega',
    'giga',
    'tera',
    'peta',
    'exa',
    'zetta',
    'yotta',
    'micro',
    'nano',
    'pico',
    'femto',
    'atto',
    'zepto',
    'yocto',
    'kilo',
    'mega',
    'giga',
    'tera',
    'peta',
    'exa',
    'zetta',
    'yotta'
  ];

  // Check if slug is reserved
  static isReservedSlug(slug: string): boolean {
    return this.RESERVED_SLUGS.includes(slug.toLowerCase());
  }

  // Validate and suggest alternative if slug is reserved or invalid
  static async validateAndSuggestSlug(
    desiredSlug: string, 
    fallbackTitle: string, 
    excludeId?: string
  ): Promise<{ isValid: boolean; slug: string; message?: string }> {
    const cleanSlug = desiredSlug.toLowerCase().trim();

    // Check if empty
    if (!cleanSlug) {
      const suggestedSlug = await this.generateUniqueSlug(fallbackTitle, excludeId);
      return {
        isValid: false,
        slug: suggestedSlug,
        message: 'Slug não pode estar vazio. Sugestão gerada automaticamente.',
      };
    }

    // Check format
    if (!this.isValidSlug(cleanSlug)) {
      const suggestedSlug = await this.generateUniqueSlug(fallbackTitle, excludeId);
      return {
        isValid: false,
        slug: suggestedSlug,
        message: 'Slug deve conter apenas letras minúsculas, números e hífens. Sugestão gerada automaticamente.',
      };
    }

    // Check if reserved
    if (this.isReservedSlug(cleanSlug)) {
      const suggestedSlug = await this.generateUniqueSlug(fallbackTitle, excludeId);
      return {
        isValid: false,
        slug: suggestedSlug,
        message: 'Este slug é reservado pelo sistema. Sugestão gerada automaticamente.',
      };
    }

    // Check availability
    const isAvailable = await this.isSlugAvailable(cleanSlug, excludeId);
    if (!isAvailable) {
      const suggestedSlug = await this.generateUniqueSlug(fallbackTitle, excludeId);
      return {
        isValid: false,
        slug: suggestedSlug,
        message: 'Este slug já está em uso. Sugestão gerada automaticamente.',
      };
    }

    return {
      isValid: true,
      slug: cleanSlug,
    };
  }
}